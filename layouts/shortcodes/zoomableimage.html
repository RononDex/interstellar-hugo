{{ $_hugo_config := `{ "version": 1 }` }}
{{ if isset .Scratch "numberOfImageDialogs" }}
	{{ $.Scratch.Set "numberOfImageDialogs" (add ($.Scratch.Get "numberOfImageDialogs") 1) }}
{{ else }}
	{{ $.Scratch.Set "numberOfImageDialogs" 1 }}
{{ end }}

<div class="zoomableImage">
  <h4>Zoomable, full-resolution image:</h4>
  <div class="hoverwrap">
    <div
      class="hovercap"
      data-toggle="modal"
	  data-target="#zoomableImageDialog-{{ $.Scratch.Get "numberOfImageDialogs" }}"
    >
      Click me
    </div>
    <img src="{{ .Get "folderPath" }}/thumb.webp" />
  </div>
</div>

<div
  class="modal fade modal-fullscreen"
  id="zoomableImageDialog-{{ $.Scratch.Get "numberOfImageDialogs" }}"
  tabindex="-1"
  aria-labelledby="zoomableImage"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="seadragonToolbarDiv">
          <div id="zoom-in-btn" class="seadragonButton">
            <img src="/plugins/openseadragon/images/zoomin_rest.png" />
          </div>
          <div id="zoom-out-btn" class="seadragonButton">
            <img src="/plugins/openseadragon/images/zoomout_rest.png" />
          </div>
          {{ if fileExists (print (print "/static" (.Get "folderPath")) "/annotations.svg") }}
          <div
            id="annotations-btn"
            class="seadragonButton"
            onclick="toggleSvgOverlay()"
          >
            <img src="/images/annotations-icon.webp" />
          </div>
          {{ end }}
          <div id="home-btn" class="seadragonButton">
            <img src="/plugins/openseadragon/images/home_rest.png" />
          </div>
          <div id="full-page-btn" class="seadragonButton">
            <img src="/plugins/openseadragon/images/fullpage_rest.png" />
          </div>
        </div>
        <div id="zoomPercentDisplay"></div>
		<div id="zoomableImageDisplay{{ $.Scratch.Get "numberOfImageDialogs" }}"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  if (typeof functionsAfterDocumentReady === 'undefined') {
      functionsAfterDocumentReady = [];
  }

  functionsAfterDocumentReady.push(function () {
	  var viewer = OpenSeadragon({
		  id: "zoomableImageDisplay{{ $.Scratch.Get "numberOfImageDialogs" }}",
          autoHideControls: false,
          imageSmoothingEnabled: false,
          showNavigator: false,
          defaultZoomLevel: 0,
          toolbar: 'seadragonToolbarDiv',
          zoomInButton: "zoom-in-btn",
          zoomOutButton: "zoom-out-btn",
          homeButton: "home-btn",
          fullPageButton: "full-page-btn",
          prefixUrl: '/plugins/openseadragon/images/',
          visibilityRatio: 0.9,
          tileSources: "{{ .Get "folderPath" }}/tiled_photo.dzi",
      });

      document.activeSeadragonViewer = viewer;
      addZoomDisplay(viewer);
  });

  var svgOverlayActive = false;

  function toggleSvgOverlay() {
      if (svgOverlayActive) {
          var overlay = document.activeSeadragonViewer.svgOverlay();
          var node = overlay.node();
          while (node.hasChildNodes()) {
              node.removeChild(node.lastChild);
          }
          svgOverlayActive = false;
      }
      else {
        addSvgOverlayToOpenSeadragonViewer("{{ print (.Get "folderPath") "/annotations.svg" }}",
        document.activeSeadragonViewer);
          svgOverlayActive = true;
      }
  }
</script>
